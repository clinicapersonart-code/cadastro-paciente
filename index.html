<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cadastro de Pacientes — Clínica Personart</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --text:#f8fafc; --muted:#cbd5e1;
    --brand:#f4c49b; --brand-dark:#e7b88f; --accent:#0d4442;
    --chip:#1f2937; --border:#374151; --danger:#ef4444; --warning:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--text);
       background: radial-gradient(1200px 300px at 10% -10%, rgba(13,68,66,.25), transparent),
                   linear-gradient(180deg,#0b1220 0%, #0f172a 100%)}
  header{padding:24px 16px 8px}
  .container{max-width:1200px;margin:0 auto;padding:8px 16px 32px}
  h1{margin:0 0 8px;font-size:clamp(22px,2.6vw,36px);letter-spacing:.3px}
  .brand{color:var(--brand)}
  .subtitle{color:#a8b3c7;font-size:14px;margin:0}
  .grid{display:grid;gap:16px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media(max-width:820px){.grid.cols-2{grid-template-columns:1fr}}
  .card{background:
        radial-gradient(1000px 220px at 8% -8%, rgba(244,196,155,.08), transparent),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
        border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,.35)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"], input[type="date"], input[type="tel"], input[type="email"], select, textarea{
    width:100%; background:#0b1220; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none
  }
  textarea{resize:vertical; min-height:72px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .radio{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);background:#0b1220;border-radius:999px;cursor:pointer;font-size:13px}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--brand);color:#1f1b16}
  .btn-primary:hover{background:var(--brand-dark)}
  .btn-outline{background:transparent;color:var(--text);border:1px solid var(--border)}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-xs{padding:6px 10px;border-radius:10px;font-size:12px}
  .muted{color:#9ca3af;font-size:12px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;display:inline-flex;align-items:center;gap:8px}
  .chip button{all:unset;cursor:pointer;color:#fca5a5}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;vertical-align:top;font-size:14px}
  th{position:sticky;top:0;background:#0f172a;z-index:1}
  tr:hover{background:rgba(255,255,255,.02)}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .toolbar .spacer{flex:1}
  .footer{text-align:center;color:#9ca3af;font-size:12px;padding:12px}
  .badge{display:inline-block;background:var(--accent);color:#dff5f4;padding:4px 8px;border-radius:999px;font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:8px}
  .divider{height:1px;background:var(--border);margin:8px 0}
</style>
</head>
<body>
<header class="container">
  <h1><span class="brand">Clínica Personart</span></h1>
  <p class="subtitle">Registre pacientes, convênios, profissionais, especialidades e origens. Os dados ficam no seu navegador. Exporte e importe backups quando quiser.</p>
</header>

<main class="container grid cols-2">
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="pill"><span class="badge">Novo / Editar Paciente</span></div>
      <button id="btn-visual" class="btn btn-outline btn-xs">Identidade visual</button>
    </div>
    <div class="divider"></div>

    <form id="patient-form">
      <input type="hidden" id="patient-id" />
      <div class="grid cols-2">
        <div>
          <label for="nome">Nome do paciente *</label>
          <input id="nome" type="text" required placeholder="Ex.: Ana Silva" />
        </div>
        <div>
          <label for="nascimento">Data de nascimento</label>
          <input id="nascimento" type="date" />
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <span class="muted">Faixa etária:</span>
        <label class="radio"><input type="radio" name="faixa" value="Criança" id="faixa-crianca"> Criança</label>
        <label class="radio"><input type="radio" name="faixa" value="Adulto" id="faixa-adulto"> Adulto</label>
      </div>

      <div id="responsavel-wrap" style="margin-top:10px; display:none;">
        <label for="responsavel">Nome do responsável (obrigatório para criança)</label>
        <input id="responsavel" type="text" placeholder="Ex.: Maria de Souza" />
      </div>

      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label for="endereco">Endereço</label>
          <input id="endereco" type="text" placeholder="Rua, nº, bairro, cidade" />
        </div>
        <div>
          <label for="contato">Contato (telefone/e-mail)</label>
          <input id="contato" type="text" placeholder="(15) 9 9999-9999 / paciente@exemplo.com" />
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label for="convenio">Convênio</label>
          <div class="row">
            <select id="convenio" style="flex:1"></select>
            <button type="button" class="btn btn-outline btn-xs" id="btn-add-convenio">+ convênio</button>
          </div>
          <div class="muted">Lista editável.</div>
        </div>

        <div>
          <label for="especialidade">Especialidade</label>
          <div class="row">
            <select id="especialidade" style="flex:1"></select>
            <button type="button" class="btn btn-outline btn-xs" id="btn-add-esp">+ especialidade</button>
          </div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Profissionais que estão atendendo</label>
        <div class="row">
          <select id="prof-select" style="flex:1"></select>
          <button type="button" class="btn btn-outline btn-xs" id="btn-add-prof-novo">+ profissional</button>
          <button type="button" class="btn btn-primary btn-xs" id="btn-prof-adicionar">Adicionar</button>
        </div>
        <div id="pro-chips" class="chips" style="margin-top:8px"></div>
      </div>

      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label for="crm">CRM do médico que encaminhou</label>
          <input id="crm" type="text" placeholder="Ex.: CRM-SP 123456" />
        </div>
        <div>
          <label for="origem">Origem (como conheceu a clínica)</label>
          <div class="row">
            <select id="origem" style="flex:1"></select>
            <button type="button" class="btn btn-outline btn-xs" id="btn-add-origem">+ origem</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn btn-primary" type="submit">Salvar paciente</button>
        <button class="btn btn-outline" type="button" id="btn-limpar">Limpar formulário</button>
      </div>
    </form>
  </section>

  <section class="card">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div class="pill"><span class="badge">Pacientes</span></div>
      <button class="btn btn-danger btn-xs" id="btn-zerar" title="Apagar todos os pacientes">Limpar dados</button>
    </div>
    <div class="divider"></div>

    <div class="toolbar">
      <input id="busca" type="text" placeholder="Buscar por nome, responsável, contato, CRM ou origem" style="min-width:240px" />
      <select id="filtro-convenio"><option value="">Todos os convênios</option></select>
      <select id="filtro-profissional"><option value="">Todos os profissionais</option></select>
      <select id="filtro-faixa">
        <option value="">Todas as faixas</option>
        <option value="Criança">Criança</option>
        <option value="Adulto">Adulto</option>
      </select>
      <div class="spacer"></div>
      <button class="btn btn-outline" id="btn-ver">Ver todos</button>
      <button class="btn btn-outline" id="btn-exportar">Baixar backup (.json)</button>
      <label class="btn btn-outline" for="importar" style="cursor:pointer">Importar backup</label>
      <input id="importar" type="file" accept="application/json" style="display:none" />
    </div>

    <div id="wrap-tabela" style="display:none; overflow:auto; max-height:55vh; border:1px solid var(--border); border-radius:12px;">
      <table id="tabela">
        <thead>
          <tr>
            <th style="min-width:180px">Paciente</th>
            <th>Nasc.</th>
            <th>Faixa</th>
            <th>Responsável</th>
            <th>Endereço</th>
            <th>Contato</th>
            <th>Convênio</th>
            <th>Especialidade</th>
            <th>Profissionais</th>
            <th>CRM</th>
            <th>Origem</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="muted" id="contador" style="margin-top:8px">0 pacientes</div>
  </section>
</main>

<footer class="footer">LGPD: mantenha backups seguros. Os dados ficam apenas neste navegador, a menos que você exporte/importe.</footer>

<script>
(function(){
  var $ = function(s,r){return (r||document).querySelector(s)};
  var $$ = function(s,r){return Array.prototype.slice.call((r||document).querySelectorAll(s));};

  var STORAGE_KEYS = {
    PAC:'personart.pacientes.v71',
    CONV:'personart.convenios.v71',
    PROS:'personart.profissionais.v71',
    ESP:'personart.especialidades.v71',
    ORIG:'personart.origens.v71'
  };

  var DEFAULT_CONV = ['Funserv','Danamed','Gama Saúde','Fusex','BlueSaúde','Unimed Campinas','Ossel','Ofebas'];
  var DEFAULT_PROS = ['Bruno Alexandre','Janaina Davi','Stephanie Magon','Soraia Souza','Simone Agrela','Maria Pedroso'];
  var DEFAULT_ESP = ['Psicologia','Fonoaudiologia','Terapia Ocupacional','Nutrição'];
  var DEFAULT_ORIG = ['Indicação','Google','Instagram','Site','Google Maps','Outro'];

  function loadJSON(k,f){ try{ var t=localStorage.getItem(k); return t?JSON.parse(t):f; }catch(e){ return f; } }
  function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

  function parseISO(iso){
    if(!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return null;
    var a = iso.split('-'); return new Date(+a[0], +a[1]-1, +a[2]);
  }
  function formatDateBR(iso){
    var d=parseISO(iso); if(!d) return '';
    try{ return d.toLocaleDateString('pt-BR', { timeZone:'America/Sao_Paulo' }); }
    catch(e){ var dd=('0'+d.getDate()).slice(2); var mm=('0'+(d.getMonth()+1)).slice(2); var yy=d.getFullYear(); return dd+'/'+mm+'/'+yy; }
  }

  var pacientes = loadJSON(STORAGE_KEYS.PAC, []);
  var convenios = loadJSON(STORAGE_KEYS.CONV, DEFAULT_CONV);
  var profissionais = loadJSON(STORAGE_KEYS.PROS, DEFAULT_PROS);
  var especialidades = loadJSON(STORAGE_KEYS.ESP, DEFAULT_ESP);
  var origens = loadJSON(STORAGE_KEYS.ORIG, DEFAULT_ORIG);

  function ensureDefaults(){
    if(!convenios || !convenios.length) convenios = DEFAULT_CONV.slice();
    if(!profissionais || !profissionais.length) profissionais = DEFAULT_PROS.slice();
    if(!especialidades || !especialidades.length) especialidades = DEFAULT_ESP.slice();
    if(!origens || !origens.length) origens = DEFAULT_ORIG.slice();
    convenios.sort(localeSort); profissionais.sort(localeSort);
    especialidades.sort(localeSort); origens.sort(localeSort);
  }
  function localeSort(a,b){ return String(a||'').localeCompare(String(b||''), 'pt-BR'); }

  function renderSelect(selId, items){
    var sel = $(selId); var html='';
    for(var i=0;i<items.length;i++){ html+='<option value="'+items[i]+'">'+items[i]+'</option>'; }
    sel.innerHTML = html;
  }

  function renderAllSelects(){
    renderSelect('#convenio', convenios);
    renderSelect('#prof-select', profissionais);
    renderSelect('#especialidade', especialidades);
    renderSelect('#origem', origens);

    var fconv = $('#filtro-convenio'), fpro = $('#filtro-profissional');
    var keepConv = fconv.value, keepPro = fpro.value, i, html;
    html = '<option value="">Todos os convênios</option>';
    for(i=0;i<convenios.length;i++){ html+='<option value="'+convenios[i]+'">'+convenios[i]+'</option>'; }
    fconv.innerHTML = html;
    html = '<option value="">Todos os profissionais</option>';
    for(i=0;i<profissionais.length;i++){ html+='<option value="'+profissionais[i]+'">'+profissionais[i]+'</option>'; }
    fpro.innerHTML = html;
    for(i=0;i<fconv.options.length;i++){ if(fconv.options[i].value===keepConv){ fconv.value=keepConv; break; } }
    for(i=0;i<fpro.options.length;i++){ if(fpro.options[i].value===keepPro){ fpro.value=keepPro; break; } }
  }

  function clearForm(){
    $('#patient-id').value = '';
    $('#nome').value = '';
    $('#nascimento').value = '';
    $('#faixa-crianca').checked = false;
    $('#faixa-adulto').checked = false;
    $('#responsavel-wrap').style.display = 'none';
    $('#responsavel').value = '';
    $('#endereco').value = '';
    $('#contato').value = '';
    $('#crm').value = '';
    $('#convenio').selectedIndex = 0;
    $('#especialidade').selectedIndex = 0;
    $('#origem').selectedIndex = 0;
    $('#pro-chips').innerHTML = '';
  }

  function getSelectedPros(){
    var chips = $$('#pro-chips .chip'); var out=[]; for(var i=0;i<chips.length;i++){ out.push(chips[i].getAttribute('data-name')); } return out;
  }

  function addProChip(name){
    if(!name) return;
    var cur = getSelectedPros(); if(cur.indexOf(name)!==-1) return;
    var chip = document.createElement('span');
    chip.className='chip'; chip.setAttribute('data-name', name);
    chip.innerHTML = '<span>'+name+'</span><button title="remover" aria-label="remover">&times;</button>';
    chip.querySelector('button').addEventListener('click', function(){ chip.remove(); });
    $('#pro-chips').appendChild(chip);
  }

  function updateFaixaUI(){
    $('#responsavel-wrap').style.display = $('#faixa-crianca').checked ? '' : 'none';
  }

  function fillForm(p){
    $('#patient-id').value = p.id;
    $('#nome').value = p.nome || '';
    $('#nascimento').value = p.nascimento || '';
    if(p.faixa==='Criança'){ $('#faixa-crianca').checked = true; } else if(p.faixa==='Adulto'){ $('#faixa-adulto').checked = true; } else { $('#faixa-crianca').checked=false; $('#faixa-adulto').checked=false; }
    updateFaixaUI();
    $('#responsavel').value = p.responsavel || '';
    $('#endereco').value = p.endereco || '';
    $('#contato').value = p.contato || '';
    $('#crm').value = p.crm || '';
    $('#convenio').value = p.convenio || '';
    $('#especialidade').value = p.especialidade || '';
    $('#origem').value = p.origem || '';
    $('#pro-chips').innerHTML = '';
    var i; var arr=p.profissionais||[];
    for(i=0;i<arr.length;i++){ addProChip(arr[i]); }
    window.scrollTo(0,0);
  }

  function getFormData(){
    var nome = $('#nome').value.trim();
    var nascimento = $('#nascimento').value || '';
    var faixa = $('#faixa-crianca').checked ? 'Criança' : ($('#faixa-adulto').checked ? 'Adulto' : '');
    var responsavel = $('#responsavel').value.trim();
    var endereco = $('#endereco').value.trim();
    var contato = $('#contato').value.trim();
    var convenio = $('#convenio').value || '';
    var especialidade = $('#especialidade').value || '';
    var origem = $('#origem').value || '';
    var crm = $('#crm').value.trim();
    var profissionaisSel = getSelectedPros();
    return { nome:nome, nascimento:nascimento, faixa:faixa, responsavel:responsavel, endereco:endereco, contato:contato, convenio:convenio, especialidade:especialidade, origem:origem, crm:crm, profissionais:profissionaisSel };
  }

  function validateForm(d){
    if(!d.nome) return 'Informe o nome do paciente.';
    if(!d.faixa) return 'Selecione se é Criança ou Adulto.';
    if(d.faixa==='Criança' && !d.responsavel) return 'Informe o nome do responsável para pacientes criança.';
    return null;
  }

  function renderTable(){
    var tbody = $('#tabela tbody'); tbody.innerHTML = '';
    var q = $('#busca').value.toLowerCase().trim();
    var fConv = $('#filtro-convenio').value;
    var fPro = $('#filtro-profissional').value;
    var fFaixa = $('#filtro-faixa').value;

    var filtered = pacientes.filter(function(p){
      var blob = [p.nome,p.responsavel,p.contato,p.crm,p.origem].filter(Boolean).join(' ').toLowerCase();
      if(q && blob.indexOf(q)===-1) return false;
      if(fConv && p.convenio!==fConv) return false;
      if(fFaixa && p.faixa!==fFaixa) return false;
      if(fPro && !(p.profissionais && p.profissionais.indexOf(fPro)!==-1)) return false;
      return true;
    }).sort(function(a,b){ return (a.nome||'').localeCompare(b.nome||'','pt-BR'); });

    for(var i=0;i<filtered.length;i++){
      var p=filtered[i];
      var tr = document.createElement('tr');
      var tdNome=document.createElement('td'); tdNome.innerHTML='<strong>'+(p.nome||'')+'</strong>';
      var tdNasc=document.createElement('td'); tdNasc.textContent=formatDateBR(p.nascimento);
      var tdFaixa=document.createElement('td'); tdFaixa.textContent=p.faixa||'';
      var tdResp=document.createElement('td'); tdResp.textContent=p.faixa==='Criança'?(p.responsavel||''):'';
      var tdEnd=document.createElement('td'); tdEnd.textContent=p.endereco||'';
      var tdContato=document.createElement('td'); tdContato.textContent=p.contato||'';
      var tdConv=document.createElement('td'); tdConv.textContent=p.convenio||'';
      var tdEsp=document.createElement('td'); tdEsp.textContent=p.especialidade||'';
      var tdPros=document.createElement('td');
      var j, arr=p.profissionais||[]; for(j=0;j<arr.length;j++){ var s=document.createElement('span'); s.className='chip'; s.textContent=arr[j]; tdPros.appendChild(s); tdPros.appendChild(document.createTextNode(' ')); }
      var tdCrm=document.createElement('td'); tdCrm.textContent=p.crm||'';
      var tdOrig=document.createElement('td'); tdOrig.textContent=p.origem||'';
      var tdAcoes=document.createElement('td');
      var bE=document.createElement('button'); bE.className='btn btn-outline btn-xs'; bE.textContent='Editar';
      var bX=document.createElement('button'); bX.className='btn btn-danger btn-xs'; bX.textContent='Excluir';
      bE.addEventListener('click', (function(pp){ return function(){ fillForm(pp); };})(p));
      bX.addEventListener('click', (function(pid){ return function(){ if(confirm('Excluir este paciente?')){ pacientes = pacientes.filter(function(x){return x.id!==pid;}); saveJSON(STORAGE_KEYS.PAC, pacientes); renderTable(); } };})(p.id));
      tdAcoes.appendChild(bE); tdAcoes.appendChild(bX);
      [tdNome,tdNasc,tdFaixa,tdResp,tdEnd,tdContato,tdConv,tdEsp,tdPros,tdCrm,tdOrig,tdAcoes].forEach(function(td){ tr.appendChild(td); });
      tbody.appendChild(tr);
    }
    $('#contador').textContent = filtered.length+' paciente'+(filtered.length===1?'':'s');
  }

  // Eventos UI (compatíveis)
  $('#nascimento').addEventListener('change', function(){
    var iso = $('#nascimento').value; if(!iso) return;
    var d = parseISO(iso); if(!d) return;
    var now=new Date(); var age=now.getFullYear()-d.getFullYear();
    var m=now.getMonth()-d.getMonth();
    if(m<0 || (m===0 && now.getDate()<d.getDate())) age--;
    if(age<18){ $('#faixa-crianca').checked=true; } else { $('#faixa-adulto').checked=true; }
    updateFaixaUI();
  });
  $('#faixa-crianca').addEventListener('change', updateFaixaUI);
  $('#faixa-adulto').addEventListener('change', updateFaixaUI);
  // também reage a "click" (alguns Android antigos só disparam click)
  $('#faixa-crianca').addEventListener('click', updateFaixaUI);
  $('#faixa-adulto').addEventListener('click', updateFaixaUI);

  // Mestre: adicionar novos itens
  $('#btn-add-convenio').addEventListener('click', function(){
    var v = prompt('Novo convênio:'); if(!v) return; v=v.trim(); if(!v) return;
    var i, found=false; for(i=0;i<convenios.length;i++){ if(convenios[i].toLowerCase()===v.toLowerCase()) found=true; }
    if(!found){ convenios.push(v); convenios.sort(localeSort); saveJSON(STORAGE_KEYS.CONV, convenios); renderAllSelects(); $('#convenio').value=v; }
  });
  $('#btn-add-esp').addEventListener('click', function(){
    var v = prompt('Nova especialidade:'); if(!v) return; v=v.trim(); if(!v) return;
    var i, found=false; for(i=0;i<especialidades.length;i++){ if(especialidades[i].toLowerCase()===v.toLowerCase()) found=true; }
    if(!found){ especialidades.push(v); especialidades.sort(localeSort); saveJSON(STORAGE_KEYS.ESP, especialidades); renderAllSelects(); $('#especialidade').value=v; }
  });
  $('#btn-add-origem').addEventListener('click', function(){
    var v = prompt('Nova origem (como conheceu a clínica):'); if(!v) return; v=v.trim(); if(!v) return;
    var i, found=false; for(i=0;i<origens.length;i++){ if(origens[i].toLowerCase()===v.toLowerCase()) found=true; }
    if(!found){ origens.push(v); origens.sort(localeSort); saveJSON(STORAGE_KEYS.ORIG, origens); renderAllSelects(); $('#origem').value=v; }
  });
  $('#btn-add-prof-novo').addEventListener('click', function(){
    var v = prompt('Novo(a) profissional:'); if(!v) return; v=v.trim(); if(!v) return;
    var i, found=false; for(i=0;i<profissionais.length;i++){ if(profissionais[i].toLowerCase()===v.toLowerCase()) found=true; }
    if(!found){ profissionais.push(v); profissionais.sort(localeSort); saveJSON(STORAGE_KEYS.PROS, profissionais); renderAllSelects(); $('#prof-select').value=v; }
  });
  $('#btn-prof-adicionar').addEventListener('click', function(){ addProChip($('#prof-select').value); });

  // Submit
  $('#patient-form').addEventListener('submit', function(e){
    e.preventDefault();
    var id = $('#patient-id').value || uid();
    var data = getFormData();
    var err = validateForm(data); if(err){ alert(err); return; }
    var i, idx=-1; for(i=0;i<pacientes.length;i++){ if(pacientes[i].id===id){ idx=i; break; } }
    var rec = { id:id, nome:data.nome, nascimento:data.nascimento, faixa:data.faixa, responsavel:data.responsavel, endereco:data.endereco, contato:data.contato, convenio:data.convenio, especialidade:data.especialidade, origem:data.origem, crm:data.crm, profissionais:data.profissionais };
    if(idx>=0) pacientes[idx]=rec; else pacientes.push(rec);
    saveJSON(STORAGE_KEYS.PAC, pacientes);
    clearForm();
    if($('#wrap-tabela').style.display!=='none') renderTable();
    alert('Paciente salvo.');
  });

  // Limpar / Ver / Filtros
  $('#btn-limpar').addEventListener('click', clearForm);
  $('#btn-ver').addEventListener('click', function(){
    var wrap = $('#wrap-tabela');
    if(wrap.style.display==='none'){ wrap.style.display='block'; renderTable(); $('#btn-ver').textContent='Ocultar'; }
    else { wrap.style.display='none'; $('#btn-ver').textContent='Ver todos'; }
  });
  ['busca','filtro-convenio','filtro-profissional','filtro-faixa'].forEach(function(id){
    document.getElementById(id).addEventListener('input', function(){ if($('#wrap-tabela').style.display!=='none') renderTable(); });
    document.getElementById(id).addEventListener('change', function(){ if($('#wrap-tabela').style.display!=='none') renderTable(); });
  });

  // Export / Import / Zerar
  function download(filename, content, type){
    var blob = new Blob([content], {type:type||'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  $('#btn-exportar').addEventListener('click', function(){
    var payload = { pacientes:pacientes, convenios:convenios, profissionais:profissionais, especialidades:especialidades, origens:origens, ts:new Date().toISOString() };
    download('backup_personart.json', JSON.stringify(payload, null, 2), 'application/json');
  });
  $('#importar').addEventListener('change', function(ev){
    var file = ev && ev.target && ev.target.files && ev.target.files[0]; if(!file) return;
    var reader = new FileReader();
    reader.onload = function(){
      try{
        var data = JSON.parse(String(reader.result||'{}'));
        if(data && data.pacientes && data.pacientes.splice) pacientes = data.pacientes;
        else if(data && data.splice) pacientes = data;
        else throw new Error('Formato inválido');
        if(data.convenios && data.convenios.splice) convenios = data.convenios;
        if(data.profissionais && data.profissionais.splice) profissionais = data.profissionais;
        if(data.especialidades && data.especialidades.splice) especialidades = data.especialidades;
        if(data.origens && data.origens.splice) origens = data.origens;
        saveJSON(STORAGE_KEYS.PAC, pacientes);
        saveJSON(STORAGE_KEYS.CONV, convenios);
        saveJSON(STORAGE_KEYS.PROS, profissionais);
        saveJSON(STORAGE_KEYS.ESP, especialidades);
        saveJSON(STORAGE_KEYS.ORIG, origens);
        renderAllSelects();
        if($('#wrap-tabela').style.display!=='none') renderTable();
        alert('Backup importado com sucesso.');
      }catch(e){
        alert('Falha ao importar: '+(e && e.message ? e.message : e));
      }finally{
        ev.target.value='';
      }
    };
    reader.readAsText(file);
  });
  $('#btn-zerar').addEventListener('click', function(){
    if(!confirm('Tem certeza que deseja apagar TODOS os pacientes deste navegador?')) return;
    pacientes = []; saveJSON(STORAGE_KEYS.PAC, pacientes);
    if($('#wrap-tabela').style.display!=='none') renderTable();
  });

  $('#btn-visual').addEventListener('click', function(){
    alert('Identidade visual ajustada às cores da Personart (bege + verde petróleo).');
  });

  // Init
  (function init(){
    ensureDefaults();
    renderAllSelects();
    clearForm();
    $('#wrap-tabela').style.display='none';
  })();
})();
</script>
</body>
</html>
